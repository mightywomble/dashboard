{% extends "base.html" %}

{% block title %}Home Dashboard{% endblock %}

{% block content %}
<!-- Chatbot Toggle Button -->
{% if session.logged_in %}
<div id="chatbot-toggle" class="fixed left-4 top-1/2 transform -translate-y-1/2 z-40 cursor-pointer">
    <div class="glass-nav-button bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-r-lg flex items-center space-x-2 transition-all duration-300">
        <i class="fas fa-robot text-lg"></i>
        <span class="text-sm font-medium whitespace-nowrap">Chatbot</span>
    </div>
</div>
{% endif %}

<!-- Main Dashboard Content -->
<div class="w-full">
    <h1 class="text-4xl font-bold text-center mb-12 text-white">My Dashboard</h1>
    
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-6">
{% for group in groups %}
<div class="glass-card rounded-xl p-4 flex flex-col">
    <h2 class="text-xl font-bold mb-4 flex items-center text-white border-b border-gray-600 pb-2">
        {% if group.icon %}
            <img src="{{ url_for('static', filename='icons/' + group.icon) }}" class="w-6 h-6 mr-3" alt="{{ group.name }} icon">
        {% endif %}
        {{ group.name }}
    </h2>
    <div class="flex-grow space-y-3">
        {% for link in group.links %}
        <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="block glass-card rounded-lg p-3 hover:bg-white/20 transition duration-300">
            <div class="flex items-center">
                {% if link.icon %}
                <img src="{{ url_for('static', filename='uploads/' + link.icon) }}" class="w-10 h-10 rounded-md mr-4 object-cover" alt="{{ link.name }} icon">
                {% else %}
                <div class="w-10 h-10 rounded-md mr-4 bg-gray-700 flex items-center justify-center text-xl font-bold">
                    {{ link.name[0] }}
                </div>
                {% endif %}
                <div>
                    <h3 class="font-semibold text-white">{{ link.name }}</h3>
                    <p class="text-xs text-gray-300">{{ link.description }}</p>
                </div>
            </div>
        </a>
        {% else %}
        <p class="text-gray-400 text-sm">No links in this group yet.</p>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="col-span-full text-center py-16">
    <h2 class="text-2xl font-semibold text-gray-400">Your dashboard is empty!</h2>
    <p class="text-gray-500 mt-2">Log in as an admin to add groups and links.</p>
</div>
{% endfor %}
    </div>
</div>

<!-- Chatbot Slide-out Panel -->
{% if session.logged_in %}
<div id="chatbot-panel" class="fixed right-0 top-0 h-full w-96 transform translate-x-full transition-transform duration-300 ease-in-out z-50">
    <!-- Backdrop -->
    <div id="chatbot-backdrop" class="fixed inset-0 bg-black bg-opacity-50 opacity-0 transition-opacity duration-300 pointer-events-none"></div>
    
    <!-- Panel Content -->
    <div class="relative h-full bg-gradient-to-br from-gray-900/95 to-gray-800/95 backdrop-blur-xl border-l border-gray-600 shadow-2xl">
        <div class="glass-card rounded-none h-full flex flex-col border-0">
            <!-- Chatbot Header -->
            <div class="border-b border-gray-600 p-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-robot mr-3 text-purple-400"></i>
                        AI Assistant
                    </h2>
                    <button id="chatbot-close" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                <div class="mt-3">
                    <select id="ai-service" class="glass-input text-sm rounded-lg w-full p-2">
                        <option value="openai">ChatGPT-4o</option>
                        <option value="gemini-2.5-flash">Gemini-2.5-flash</option>
                    </select>
                </div>
            </div>
            
            <!-- Chat Messages -->
            <div id="chat-messages" class="flex-1 overflow-y-auto space-y-3 p-4">
                <div class="glass-message-ai">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="glass-bubble-ai">
                            <p class="text-white text-sm">Hello! I'm your AI assistant. Ask me anything about your servers, troubleshooting, or general tech questions!</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Input -->
            <div class="p-4 border-t border-gray-600">
                <div class="flex space-x-2">
                    <input type="text" id="chat-input" class="glass-input text-sm rounded-lg flex-1 p-2.5" placeholder="Ask me anything..." onkeypress="handleChatKeyPress(event)">
                    <button onclick="sendMessage()" class="glass-nav-button bg-purple-600 hover:bg-purple-700 text-white p-2.5 rounded-lg">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessageToChat(message, 'user');
    
    // Clear input
    input.value = '';
    
    // Show typing indicator
    addTypingIndicator();
    
    // Get selected service
    const service = document.getElementById('ai-service').value;
    
    // Send to backend
    fetch('/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            service: service
        })
    })
    .then(response => response.json())
    .then(data => {
        removeTypingIndicator();
        if (data.error) {
            addMessageToChat(`Error: ${data.error}`, 'ai');
        } else {
            // Both APIs now return in the same format with 'message' field
            let responseText = data.message || 'No response received';
            addMessageToChat(responseText, 'ai');
        }
    })
    .catch(error => {
        removeTypingIndicator();
        console.error('Error:', error);
        addMessageToChat('Sorry, there was an error connecting to the AI service.', 'ai');
    });
}

function addMessageToChat(message, sender) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    
    if (sender === 'user') {
        messageDiv.className = 'glass-message-user';
        messageDiv.innerHTML = `
            <div class="flex items-start space-x-3 justify-end">
                <div class="glass-bubble-user">
                    <p class="text-white text-sm">${message}</p>
                </div>
                <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-user text-white text-sm"></i>
                </div>
            </div>
        `;
    } else {
        messageDiv.className = 'glass-message-ai';
        messageDiv.innerHTML = `
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                <div class="glass-bubble-ai">
                    <p class="text-white text-sm">${message}</p>
                </div>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addTypingIndicator() {
    const chatMessages = document.getElementById('chat-messages');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'glass-message-ai';
    typingDiv.innerHTML = `
        <div class="flex items-start space-x-3">
            <div class="w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-robot text-white text-sm"></i>
            </div>
            <div class="glass-bubble-ai">
                <p class="text-white text-sm">
                    <i class="fas fa-circle-notch fa-spin mr-2"></i>
                    Thinking...
                </p>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}
</script>
{% endblock %}
